<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FALCON X 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { background-color: #111; color: #fff; font-family: "Poppins", sans-serif; }
    .header { background: linear-gradient(90deg, #ff7b00, #ff9e00); border-bottom: 4px solid #ff9e00; box-shadow: 0 3px 15px rgba(255, 165, 0, 0.4); }
    .header h1 { font-weight: 800; font-size: 2rem; color: white; text-shadow: -2px -2px 0 #ff7b00, 2px -2px 0 #ff7b00, -2px 2px 0 #ff7b00, 2px 2px 0 #ff7b00, 0 0 12px rgba(255, 140, 0, 0.8); letter-spacing: 1px; text-align: center; }
    h1 span { display: inline-block; padding: 5px 15px; border: 3px solid #fff; border-radius: 10px; background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 10px #ff7b00; }
    .card { background-color: #1b1b1b; color: white; border: 2px solid #ff7b00; border-radius: 15px; }
    .card-header { font-weight: 600; background-color: #ff7b00 !important; color: black !important; border-bottom: 2px solid #ff9e00; }
    .btn-primary { background-color: #ff7b00; border: none; color: black; }
    .btn-primary:hover { background-color: #ff9e00; color: black; }
    .btn-success { background-color: #00c853; border: none; }
    .btn-success:hover { background-color: #00e676; }
    .btn-danger { background-color: #d62828; }
    .btn-warning { background-color: #ffa600; color: black; }
    #map { border: 3px solid #ff7b00; border-radius: 10px; height: 500px; z-index: 1; }
    .hourglass { font-size: 48px; color: #ffae00; animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.5;transform:scale(1.1);} }
    #droneIcon { width: 60px; transform-origin: center; transition: transform 0.2s linear; }
    #aiResult img { width: 100%; border-radius: 10px; margin-top: 10px; border: 2px solid #ff7b00; }
    #aiLoading { color: #ffae00; animation: blink 1s infinite; }
    .data-box { margin-top: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; font-size: 0.9rem; }
  </style>
</head>

<body>
  <div class="container-fluid">
    <header class="header py-3 d-flex justify-content-between align-items-center">
      <h1 class="text-center flex-grow-1"><span>FALCON X 2025</span></h1>
      <button id="themeToggle" class="btn btn-sm btn-outline-light"><i class="fas fa-moon"></i></button>
    </header>

    <div class="row">
      <!-- Sidebar tr√°i -->
      <div class="col-md-2">
        <div class="card shadow-lg mb-3">
          <div class="card-header"><i class="fas fa-gamepad me-2"></i>ƒêi·ªÅu Khi·ªÉn</div>
          <div class="card-body">
            <p>Roll: <span id="rollValue">0¬∞</span></p>
            <p>Pitch: <span id="pitchValue">0¬∞</span></p>
            <p>Yaw: <span id="yawValue">0¬∞</span></p>
            <p>Throttle: <span id="throttleValue">0%</span></p>
            <button id="arm" class="btn btn-warning w-100 mt-2"><i class="fas fa-power-off me-2"></i>Arm</button>
            <button id="takeoff" class="btn btn-primary w-100 mt-2"><i class="fas fa-plane-departure me-2"></i>Takeoff</button>
            <button id="rth" class="btn btn-secondary w-100 mt-2"><i class="fas fa-home me-2"></i>Return Home</button>
          </div>
        </div>
      </div>

      <!-- B·∫£n ƒë·ªì -->
      <div class="col-md-7">
        <div class="card shadow-lg mb-3">
          <div class="card-header"><i class="fas fa-map-marked-alt me-2"></i>B·∫£n ƒë·ªì nhi·ªám v·ª•</div>
          <div id="map"></div>
          <div class="card-footer text-center">
            <button id="startMission" class="btn btn-success m-1"><i class="fas fa-play me-2"></i>B·∫Øt ƒë·∫ßu Mission</button>
            <button id="clearWaypoints" class="btn btn-danger m-1"><i class="fas fa-trash me-2"></i>X√≥a t·∫•t c·∫£</button>
          </div>
        </div>
      </div>

      <!-- Sidebar ph·∫£i -->
      <div class="col-md-3">
        <div class="card shadow-lg mb-3">
          <div class="card-header"><i class="fas fa-satellite me-2"></i>Tr·∫°ng th√°i Drone</div>
          <div class="card-body text-center">
            <div id="droneWaitIcon"><i class="fas fa-hourglass-half hourglass"></i></div>
            <img id="droneIcon" src="https://cdn-icons-png.flaticon.com/512/2922/2922561.png" style="display:none;">
            <p class="mt-2" id="droneStatus">ƒêang ch·ªù l·ªánh...</p>
          </div>
        </div>

        <!-- AI YOLO -->
        <div class="card shadow-lg mb-3">
          <div class="card-header"><i class="fas fa-brain me-2"></i>AI Ph√¢n T√≠ch Kh√≠ H·∫≠u</div>
          <div class="card-body text-center">
            <input type="file" id="aiInput" class="form-control mb-2" accept="image/*">
            <button id="sendAI" class="btn btn-primary w-100 mb-2"><i class="fas fa-paper-plane me-2"></i>G·ª≠i ƒë·∫øn AI</button>
            <div id="aiLoading" style="display:none;">‚è≥ ƒêang ph√¢n t√≠ch...</div>
            <div id="aiResult" class="text-start"></div>

            <div class="data-box">
              <p><b>üå°Ô∏è Nhi·ªát ƒë·ªô:</b> <span id="temp">--</span>¬∞C</p>
              <p><b>üíß ƒê·ªô ·∫©m:</b> <span id="hum">--</span>%</p>
              <p><b>üß† D·ª± ƒëo√°n AI:</b> <span id="label">--</span></p>
              <p><b>üïí C·∫≠p nh·∫≠t:</b> <span id="time">--</span></p>
              <img id="liveImage" src="https://via.placeholder.com/250x150?text=Drone+Feed" class="mt-2 w-100 rounded">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map("map").setView([10.762622, 106.660172], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
  let waypoints = [], droneAngle = 0, droneFlying = false;
  const droneIconEl = document.getElementById("droneIcon"), droneWaitIcon = document.getElementById("droneWaitIcon");

  map.on("click", e => {
    const lat = e.latlng.lat.toFixed(6), lng = e.latlng.lng.toFixed(6);
    const alt = prompt("Nh·∫≠p ƒë·ªô cao bay (m):", "10");
    if (alt !== null) {
      L.marker([lat, lng]).addTo(map)
       .bindPopup(`<b>Waypoint</b><br>Lat: ${lat}<br>Lng: ${lng}<br>Alt: ${alt}m`).openPopup();
      waypoints.push({ lat, lng, alt });
    }
  });

  document.getElementById("clearWaypoints").onclick = () => {
    waypoints = []; map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
  };

  function simulateDroneMotion() {
    if (!droneFlying) return;
    droneAngle += 10;
    const roll = Math.sin(Date.now()/300)*20, pitch = Math.cos(Date.now()/400)*15;
    droneIconEl.style.transform = `rotate(${droneAngle}deg) skew(${roll}deg, ${pitch}deg)`;
    document.getElementById("rollValue").innerText = roll.toFixed(1)+"¬∞";
    document.getElementById("pitchValue").innerText = pitch.toFixed(1)+"¬∞";
    document.getElementById("yawValue").innerText = droneAngle.toFixed(1)+"¬∞";
    requestAnimationFrame(simulateDroneMotion);
  }

  document.getElementById("startMission").onclick = () => {
    if (waypoints.length===0) return alert("Ch∆∞a c√≥ waypoint n√†o!");
    document.getElementById("droneStatus").innerText = "ƒêang th·ª±c hi·ªán mission...";
    droneWaitIcon.style.display="none"; droneIconEl.style.display="inline";
    droneFlying = true; simulateDroneMotion();
  };

  // === AI YOLO Manual Upload ===
  const API_URL = "https://jadiel-sleuthlike-yadira.ngrok-free.dev/predict";
  document.getElementById("sendAI").onclick = async () => {
    const file = document.getElementById("aiInput").files[0];
    if (!file) return alert("Vui l√≤ng ch·ªçn ·∫£nh!");
    document.getElementById("aiLoading").style.display="block";
    document.getElementById("aiResult").innerHTML="";
    const reader = new FileReader();
    reader.onload = async () => {
      const base64 = reader.result.split(",")[1];
      const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ image: base64 }) });
      const data = await res.json();
      document.getElementById("aiLoading").style.display="none";
      document.getElementById("aiResult").innerHTML = `<b>K·∫øt qu·∫£ AI:</b><br><pre>${JSON.stringify(data,null,2)}</pre>` + (data.image?`<img src="data:image/jpeg;base64,${data.image}" />`:"");
    };
    reader.readAsDataURL(file);
  };

  // === üõ∞Ô∏è NH·∫¨N ·∫¢NH & D·ªÆ LI·ªÜU T·ª∞ ƒê·ªòNG T·ª™ DRONE ===
  const DRONE_API = "https://jadiel-sleuthlike-yadira.ngrok-free.dev/result.json"; // Flask / Raspberry server
  async function updateDroneFeed(){
    try {
      const res = await fetch(DRONE_API + "?t=" + new Date().getTime());
      const data = await res.json();
      document.getElementById("temp").innerText = data.temperature || "--";
      document.getElementById("hum").innerText = data.humidity || "--";
      document.getElementById("label").innerText = data.label || "--";
      document.getElementById("liveImage").src = data.image_url || "https://via.placeholder.com/250x150?text=Drone+Feed";
      document.getElementById("time").innerText = new Date().toLocaleTimeString();
    } catch (e){ console.log("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu:", e); }
  }
  setInterval(updateDroneFeed, 5000);
  updateDroneFeed();
</script>
</body>
</html>
